// ==========================================
// Prisma Schema for Webcomic Platform (Unified Roles)
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ----------------------
// ENUMS
// ----------------------
enum Role {
  USER      // ← now the only “normal user” role
  ADMIN     // ← admins remain unchanged
}

// ----------------------
// MODELS
// ----------------------

model User {
  id             Int              @id @default(autoincrement())
  username       String           @unique @db.VarChar(100)
  email          String           @unique @db.VarChar(150)
  passwordHash   String
  role           Role             @default(USER)  // ← CREATOR removed
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  comments       Comment[]
  loginLogs      LoginLog[]
  apiAccessLogs  ApiAccessLog[]

  // Creator profile is optional — created only when user becomes a creator
  creatorProfile CreatorProfile?
}

model Comic {
  id                Int             @id @default(autoincrement())
  title             String          @db.VarChar(150)
  slug              String          @unique @db.VarChar(120)
  description       String?
  coverImage        String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  posts             Post[]

  // Comic belongs to a creator profile (which belongs to a user)
  creatorProfile   CreatorProfile   @relation(fields: [creatorProfileId], references: [id], onDelete: Cascade)
  creatorProfileId Int

  @@index([slug])
}

model Post {
  id          Int       @id @default(autoincrement())
  postNumber  Int
  title       String    @db.VarChar(150)
  slug        String    @unique @db.VarChar(120)
  date        DateTime  @default(now())
  description String?
  
  comic       Comic     @relation(fields: [comicId], references: [id], onDelete: Cascade)
  comicId     Int

  images      Image[]
  comments    Comment[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([comicId, postNumber])
}

model Image {
  id              Int      @id @default(autoincrement())
  filename        String   @db.VarChar(255)
  storagePath     String?
  storageProvider String?
  order           Int
      
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId          Int
      
  createdAt       DateTime @default(now())
}

model Comment {
  id         Int       @id @default(autoincrement())
  content    String
      
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
      
  post       Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId     Int

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model Setting {
  id     Int    @id @default(autoincrement())
  key    String @unique
  value  String
}

model LoginLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  success   Boolean   @default(false)
  ipAddress String?
  userAgent String?
  createdAt DateTime  @default(now())

  user      User?     @relation(fields: [userId], references: [id])
}

model ApiAccessLog {
  id          Int       @id @default(autoincrement())
  userId      Int?
  endpoint    String
  method      String
  success     Boolean   @default(false)
  statusCode  Int?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())

  user        User?     @relation(fields: [userId], references: [id])
}

model CreatorProfile {
  id          Int       @id @default(autoincrement())
    
  // A user becomes a “creator” the moment they get this profile
  userId      Int       @unique
  user        User      @relation(fields: [userId], references: [id])

  bio         String?
  avatarUrl   String?
  website     String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  comics      Comic[]
}
